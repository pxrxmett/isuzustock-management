-- ==============================================================================
-- Script: Link LINE User ID to Staff
-- Description: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á LINE account ‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
-- Usage: ‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤ @staff_code ‡πÅ‡∏•‡∏∞ @line_user_id ‡πÅ‡∏•‡πâ‡∏ß run script
-- ==============================================================================

-- ============================================
-- üìù INSTRUCTIONS
-- ============================================
-- 1. ‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ:
SET @staff_code = 'STAFF001';                  -- ‚Üê ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
SET @line_user_id = 'U1234567890abcdef';       -- ‚Üê LINE User ID
SET @line_display_name = 'John Doe';           -- ‚Üê ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô LINE (optional)

-- 2. Run script ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô MySQL client


-- ============================================
-- STEP 1: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Staff
-- ============================================

SELECT 'üîç STEP 1: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Staff' AS step;

SELECT
  id,
  staff_code,
  CONCAT(first_name, ' ', last_name) AS full_name,
  department,
  position,
  email,
  phone,
  status,
  line_user_id AS current_line_user_id,
  is_line_linked AS currently_linked
FROM staffs
WHERE staff_code = @staff_code;

-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:
-- ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠ 1 ‡πÅ‡∏ñ‡∏ß ‚Üí Staff ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
-- ‚ùå ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‚Üí Staff ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô)


-- ============================================
-- STEP 2: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ LINE User ID ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
-- ============================================

SELECT 'üîç STEP 2: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö LINE User ID ‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà' AS step;

SELECT
  staff_code,
  CONCAT(first_name, ' ', last_name) AS full_name,
  department,
  line_user_id,
  line_display_name,
  is_line_linked
FROM staffs
WHERE line_user_id = @line_user_id;

-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:
-- ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÅ‡∏ñ‡∏ß‡πÉ‡∏î‡πÜ ‚Üí LINE User ID ‡∏ß‡πà‡∏≤‡∏á ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
-- ‚ö†Ô∏è  ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡πÅ‡∏ñ‡∏ß ‚Üí LINE User ID ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö Staff ‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß


-- ============================================
-- STEP 3: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á LINE User ID ‡∏Å‡∏±‡∏ö Staff
-- ============================================

SELECT '‚úÖ STEP 3: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á LINE User ID ‡∏Å‡∏±‡∏ö Staff' AS step;

UPDATE staffs
SET
  line_user_id = @line_user_id,
  line_display_name = @line_display_name,
  line_last_login_at = NOW(),
  is_line_linked = 1
WHERE staff_code = @staff_code
  AND status = 'active';  -- ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ staff ‡∏ó‡∏µ‡πà active

-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•:
SELECT ROW_COUNT() AS rows_updated;
-- ‚úÖ ‡∏ñ‡πâ‡∏≤ rows_updated = 1 ‚Üí ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
-- ‚ùå ‡∏ñ‡πâ‡∏≤ rows_updated = 0 ‚Üí ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (staff ‡πÑ‡∏°‡πà active ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ staff_code ‡∏ô‡∏µ‡πâ)


-- ============================================
-- STEP 4: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
-- ============================================

SELECT '‚úÖ STEP 4: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå' AS step;

SELECT
  staff_code,
  CONCAT(first_name, ' ', last_name) AS full_name,
  department,
  position,
  email,
  phone,
  status,
  line_user_id,
  line_display_name,
  is_line_linked,
  line_last_login_at,
  CASE
    WHEN line_user_id IS NOT NULL AND is_line_linked = 1
    THEN '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'
    ELSE '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á'
  END AS link_status
FROM staffs
WHERE staff_code = @staff_code;


-- ============================================
-- STEP 5: Test Login (‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ login ‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà)
-- ============================================

SELECT 'üß™ STEP 5: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ Login' AS step;

-- ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ login
SELECT
  id,
  staff_code,
  CONCAT(first_name, ' ', last_name) AS full_name,
  role,
  department,
  position,
  line_user_id,
  line_display_name,
  'JWT token will be generated by backend' AS token_note
FROM staffs
WHERE line_user_id = @line_user_id
  AND status = 'active';

-- ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡πÅ‡∏ñ‡∏ß ‚Üí Staff ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ login ‡∏î‡πâ‡∏ß‡∏¢ LINE ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß!
-- ‚ùå ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‚Üí ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ line_user_id ‡∏´‡∏£‡∏∑‡∏≠ status ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà


-- ==============================================================================
-- üîÑ ROLLBACK: ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
-- ==============================================================================

-- ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á:
/*
UPDATE staffs
SET
  line_user_id = NULL,
  line_display_name = NULL,
  is_line_linked = 0
WHERE staff_code = @staff_code;

SELECT 'üîÑ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß' AS status;
*/


-- ==============================================================================
-- üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
-- ==============================================================================

SELECT
  '=====================================' AS separator
UNION ALL
SELECT '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á LINE ‡∏Å‡∏±‡∏ö Staff ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'
UNION ALL
SELECT '=====================================' AS separator
UNION ALL
SELECT CONCAT('Staff Code: ', @staff_code)
UNION ALL
SELECT CONCAT('LINE User ID: ', @line_user_id)
UNION ALL
SELECT CONCAT('Display Name: ', @line_display_name)
UNION ALL
SELECT '=====================================' AS separator
UNION ALL
SELECT 'üéâ Staff ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Login ‡∏î‡πâ‡∏ß‡∏¢ LINE ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß!'
UNION ALL
SELECT '=====================================' AS separator;
